<!DOCTYPE html>
<html>

<head>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://d3js.org/d3-selection-multi.v1.min.js"></script>
  <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
  <style>
    .info-box {
      box-shadow: 5px 10px #888888;
      ;
    }
  </style>
</head>

<body>

</body>
<script>
  var canvasSize = 960;
  var randPointGenY = d3.scaleLinear()
    .domain([0.0, 1.0])
    .range([1, 10]);
  var randPointGenX = d3.scaleLinear()
    .domain([0.0, 1.0])
    .range([1, 10]);
  var svg = d3.select("body").append("svg")
    .attr("width", canvasSize)
    .attr("height", canvasSize)
    .call(d3.zoom().on("zoom", function () {
      svg.attr("transform", d3.event.transform)
    }))
  var nodeCanvas = svg.append('g').attr('class', 'node-canvas');
  var pathCanvas = svg.append('g').attr('class', 'path-canvas');
  var longPathCanvas = svg.append('g').attr('class', 'long-canvas');
  var legendCanvas = svg.append('g').attr('class', 'legend-canvas');
  var infoCanvas = svg.append('g').attr('class', 'info-canvas');

  d3.json('node.json').then(function (rects) {
    nodeCanvas.selectAll('rect').data(rects).enter().append('rect').each(function (d, i) {
      d3.select(this).attrs({
        id: d.id,
        x: d.x,
        y: d.y,
        width: d.width,
        height: d.height,
        'stroke-width': 1,
        'stroke': 'black',
        fill: 'none'
      });
    });
  })

  pathDensityGroup = {};
  pathLengthGroup = [];
  pathDensityColor = d3.piecewise(d3.interpolateHsl, ["green", "orange", "red", "black"])
  multiColor = d3.interpolateRainbow;
  schemeOranges = d3.interpolateOranges;
  schemeBlue = d3.interpolateBlues;
  d3.csv("data.csv").then(function (productMoves) {
    let productGroup = d3.nest()
      .key(function (d) {
        return d.product;
      })
      .entries(productMoves);
    for (idx in productGroup) {
      let product = productGroup[idx];
      var points = [];
      for (node of product.values) {
        try {
          let bBox = d3.select('#' + node.node).node().getBBox();
          points.push({
            x: (bBox.x + bBox.width / 2),
            y: (bBox.y + bBox.height / 2)
          })
        } catch (e) {
          console.log(e);
        }

      }
      intIndex = parseInt(idx);
      let factor = ((parseInt(idx) + 1) / (productGroup.length + 1));
      if (points.length == 2) {
        let randomPoint = []
        randomPoint[0] = {}
        randomPoint[1] = {}

        if (points[0].y == points[1].y) {
          quarteX = (points[0].x + points[1].x) / 4;
          randomPoint[0]['x'] = points[0].x + quarteX;
          randomPoint[1]['x'] = points[1].x - quarteX;
          randomPoint[0]['y'] = (points[0].y + parseFloat(randPointGenY(factor).toFixed(2)));
          randomPoint[1]['y'] = (points[0].y - parseFloat(randPointGenY(factor).toFixed(2)));
        } else {
          quarteY = (points[0].y + points[1].y) / 4;
          randomPoint[0]['y'] = points[0].y + quarteY;
          randomPoint[1]['y'] = points[1].y - quarteY;
          randomPoint[0]['x'] = (points[0].x + parseFloat(randPointGenX(factor).toFixed(2)));
          randomPoint[1]['x'] = (points[0].x - parseFloat(randPointGenX(factor).toFixed(2)));
        }
        points.splice(1, 0, ...randomPoint);
        //points.splice(1, 1, randomPoint);
        console.log(points);
      }
      var curveLine = d3.line().x(function (d) {
        return d.x
      }).y(function (d) {
        return d.y
      }).curve(d3.curveCardinal.tension(factor.toFixed(2)));
      let path = pathCanvas.append('path').attrs({
          d: curveLine(points),
          stroke: multiColor(factor),
          'stroke-width': 0.5,
          "fill": "none",
          class: 'move-path',
        })
        .on('mouseover', function () {
          renderInfoCanvas({
            product: product.values[0].product,
            production_no: product.values[0].production_no
          }, {
            x: d3.mouse(this)[0],
            y: d3.mouse(this)[1]
          })
          d3.select(this).attr('stroke-width', 2)
        }).on('mouseout', function () {
          removeInfoCanvas();
          d3.select(this).attr('stroke-width', 0.5)
        });
      //path.data(product.values[0]);
    }




    /*var legendsItemList = legendCanvas.selectAll('g.legend-item').data(sortedPath).enter();
    var legendsItem = legendsItemList.append('g').attrs({
      class: 'legend-item',
      cursor: 'pointer'
    });
    legendsItem.append('circle').attrs({
      cx: canvasSize - 100,
      cy: function (d, i) {
        return 100 + i * 25
      },
      r: 7,
      fill: function (d, i) {
        return schemeBlue((d.length / maxPath.length).toFixed(1))
      }
    });
    legendsItem.append('text').attrs({
      x: canvasSize - 80,
      y: function (d, i) {
        return 100 + i * 25
      },
      "text-anchor": "left",
      "alignment-baseline": "middle"

    }).text(function (d, i) {
      return d.product.key
    });
    legendsItem.on("mouseover", function () {
      pathCanvas.attr('display', 'none');
      let currentData = d3.select(this).datum();
      longPathCanvas.append('path').attrs({
        d: currentData.path,
        stroke: schemeBlue((currentData.length / maxPath.length).toFixed(1)),
        fill: 'none'
      })
    });
    legendsItem.on("mouseout", function () {
      pathCanvas.attr('display', 'block');
      longPathCanvas.selectAll('path').remove();
    });*/
  })

  function renderInfoCanvas(data, position) {
    infoCanvas.append('rect').attrs({
      class: 'info-box',
      x: position.x + 10,
      y: position.y + 10,
      width: 140,
      height: 60,
      fill: 'white',
      'stroke-width': 1,
      'stroke': 'black',
    })
    infoCanvas.append("text").text("Product name: " + data.product).attrs({
      x: position.x + 20,
      y: position.y + 30
    })
    infoCanvas.append("text").text("Product Line: " + data.production_no).attrs({
      x: position.x + 20,
      y: position.y + 50
    })
  }

  function removeInfoCanvas() {
    infoCanvas.selectAll('text').remove();
    infoCanvas.selectAll('rect').remove();
  }

  function pairwise(arr, func, skips) {

    skips = skips || 1;
    for (var i = 0; i < arr.length - skips; i++) {
      func(arr[i], arr[i + skips])
    }
  }
  var lineFunction = d3.line().x(function (d) {
    return d.x;
  }).y(function (d) {
    return d.y;
  });
</script>

</html>